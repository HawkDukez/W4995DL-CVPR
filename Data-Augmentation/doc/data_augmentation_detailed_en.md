# Detailed description of data augmentation methods

   * [Detailed description of data augmentation methods](#detailed-description-of-data-augmentation-methods)
      * [Intensity Transform](#intensity-transform)
         * [Luminance Fluctuation](#luminance-fluctuation)
         * [Contrast Transform](#contrast-transform)
      * [Image Filtering](#image-filtering)
         * [Sharpening](#sharpening)
         * [Gaussian Blur](#gaussian-blur)
      * [Perspective Transform](#perspective-transform)
         * [Mirror Flip](#mirror-flip)
         * [Image Clipping](#image-clipping)
         * [Image Stretching](#image-stretching)
         * [Lens Distortion](#lens-distortion)
      * [Injected Noise](#injected-noise)
         * [Salt and Pepper Noise](#salt-and-pepper-noise)
         * [Vignetting](#vignetting)
      * [Others](#others)
         * [Random Cutout](#random-cutout)

------

**origin image**

<img src="https://upload-images.jianshu.io/upload_images/12014150-68b3a00fdc229303.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo.jpg" width="50%;" />

## Intensity Transform

### Luminance Fluctuation

[lightness](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/lightness.py)

[darkness](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/darkness.py)

The image as a whole plus a random deviation, or the overall scale of the scaling.

- **Brightness**

  <img src="https://upload-images.jianshu.io/upload_images/12014150-52ddaafbe5baeb46.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_brightness.jpg" width="50%;" />

- **Darkness**

  <img src="https://upload-images.jianshu.io/upload_images/12014150-52fb0b2aa553d1f5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_darkness.jpg" width="50%;" />

```python
brightness = 1 + np.random.randint(1, 9) / 10
brightness_img = img.point(lambda p: p * brightness)
```

> Does not affect the label

### Contrast Transform

[contrast](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/contrast.py)

Expand the dynamic range of image gray level, compress the pixels at the two poles, and expand the pixels at the middle range.

```python
range_contrast=(-50, 50)
contrast = np.random.randint(*range_contrast)
contrast_img = img.point(lambda p: p * (contrast / 127 + 1) - contrast)
```

> Does not affect the label

<img src="https://upload-images.jianshu.io/upload_images/12014150-28d8278dee909f49.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_contrast.jpg" width="50%;" />

<br/>

## Image Filtering

### Sharpening

[sharpen](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/sharpen.py)

Enhance image edge information.

```python
identity = np.array([[0, 0, 0],
                     [0, 1, 0],
                     [0, 0, 0]])
sharpen = np.array([[ 0, -1,  0],
                    [-1,  4, -1],
                    [ 0, -1,  0]]) / 4
max_center = 4
sharp = sharpen * np.random.random() * max_center
kernel = identity + sharp
sharpen_img = cv2.filter2D(img, -1, kernel)
```

> Does not affect the label

<img src="https://upload-images.jianshu.io/upload_images/12014150-1263dc2e13f5d671.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_sharpen.jpg" width="50%;" />

### Gaussian Blur

[blur](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/blur.py)

Image smoothing.

```python
kernel_size = (7, 7)
blur_img = cv2.GaussianBlur(img,kernel_size,0)
```

> Does not affect the label

<img src="https://upload-images.jianshu.io/upload_images/12014150-58bca6cb92d4d542.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_blur.jpg" width="50%;" />

<br/>

## Perspective Transform

### Mirror Flip

[flip](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/flip.py)

Flip the image along the long axis

```python
flip_img = cv2.flip(cv2.cvtColor(np.asarray(img),cv2.COLOR_RGB2BGR), 1)
```

> The first position parameter $pos = 1 - pos$, other information unchanged, can be automatically generated by script
>
> ```python
> with open(name + "_flip.txt", "w") as outfile:
>   with open(name + ".txt", "r") as infile:
>     for line in infile.readlines():
>       words = line.split(" ")
>       horizontal_coord = float(words[1])
>       outfile.write(words[0] + " " + str(format(1-horizontal_coord, ".6f")) + " " + words[2] + " " + words[3] + " " + words[4])
> ```

<img src="https://upload-images.jianshu.io/upload_images/12014150-0336d65402d15237.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_flip.jpg" width="50%;" />

### Image Clipping

[crop](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/crop.py)

Crop the center image of the original 80% size and move it randomly

```python
kernel_size = list(map(lambda x: int(x*0.8), size))
shift_min, shift_max = -50, 50
shift_size = [np.random.randint(shift_min, shift_max), np.random.randint(shift_min, shift_max)]

crop_img = img[
  (size[0]-kernel_size[0])//2+shift_size[0]:(size[0]-kernel_size[0])//2+kernel_size[0]+shift_size[0],
  (size[1]-kernel_size[1])//2+shift_size[1]:(size[1]-kernel_size[1])//2+kernel_size[1]+shift_size[1]
]
```

> It is possible to trim off the target object and therefore re-annotate it manually

<img src="https://upload-images.jianshu.io/upload_images/12014150-346ec7617782e807.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_crop.jpg" width="50%;" />

### Image Stretching

[deform](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/deform.py)

A square image stretched to its original width.

```python
deform_img = img.resize((int(w), int(w)))
```

> The scale information in the original drawing has been changed, it is better to mark manually again

<img src="https://upload-images.jianshu.io/upload_images/12014150-ed8fd4ef139b7e75.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_deform.jpg" width="50%;" />

### Lens Distortion

[distortion](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/distortion.py)

The lens distortion of fisheye lens is simulated by means of perspective change

By playing radial coefficients k1, k2, k3 and tangential coefficients $\rho1$ and $\rho2$

```python
d_coef= np.array((0.15, 0.15, 0.1, 0.1, 0.05))
# get the height and the width of the image
h, w = img.shape[:2]
# compute its diagonal
f = (h ** 2 + w ** 2) ** 0.5
# set the image projective to carrtesian dimension
K = np.array([[f, 0, w / 2],
              [0, f, h / 2],
              [0, 0,   1  ]])
d_coef = d_coef * np.random.random(5) # value
d_coef = d_coef * (2 * (np.random.random(5) < 0.5) - 1) # sign
# Generate new camera matrix from parameters
M, _ = cv2.getOptimalNewCameraMatrix(K, d_coef, (w, h), 0)
# Generate look-up tables for remapping the camera image
remap = cv2.initUndistortRectifyMap(K, d_coef, None, M, (w, h), 5)
# Remap the original image to a new image
distortion_img = cv2.remap(img, *remap, cv2.INTER_LINEAR)
```

> It's better to relabel by hand

<img src="https://upload-images.jianshu.io/upload_images/12014150-c33b16682ef46ebf.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_distortion.jpg" width="50%;" />

<br/>

## Injected Noise

### Salt and Pepper Noise

[noise](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/noise.py)

Randomly add white/black pixels to the image.

```python
for i in range(5000):
  x = np.random.randint(0,rows)
  y = np.random.randint(0,cols)
  noise_img[x,y,:] = 255
  noise_img.flags.writeable = True
```

> Does not affect the label

<img src="https://upload-images.jianshu.io/upload_images/12014150-0264d134d8ce1211.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_noise.jpg" width="50%;" />

### Vignetting

[vignetting](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/vignetting.py)

Add a noise simulation halo to the image within a circle range.

```python
ratio_min_dist=0.2
range_vignette=np.array((0.2, 0.8))
random_sign=False

h, w = img.shape[:2]
min_dist = np.array([h, w]) / 2 * np.random.random() * ratio_min_dist

# create matrix of distance from the center on the two axis
x, y = np.meshgrid(np.linspace(-w/2, w/2, w), np.linspace(-h/2, h/2, h))
x, y = np.abs(x), np.abs(y)
# create the vignette mask on the two axis
x = (x - min_dist[0]) / (np.max(x) - min_dist[0])
x = np.clip(x, 0, 1)
y = (y - min_dist[1]) / (np.max(y) - min_dist[1])
y = np.clip(y, 0, 1)
# then get a random intensity of the vignette
vignette = (x + y) / 2 * np.random.uniform(*range_vignette)
vignette = np.tile(vignette[..., None], [1, 1, 3])
sign = 2 * (np.random.random() < 0.5) * (random_sign) - 1
vignetting_img = img * (1 + sign * vignette)
```

> Does not affect the label

<img src="https://upload-images.jianshu.io/upload_images/12014150-3e8b67995db963e3.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_vignetting.jpg" width="50%;" />

<br/>

## Others

### Random Cutout

[cutout](https://github.com/doubleZ0108/Data-Augmentation/blob/master/src/cutout.py)

Randomly cut out four positions and fill them with black/color rectangles.

```python
channel_wise = False
max_crop = 4
replacement=0

size = np.array(img.shape[:2])
mini, maxi = min_size_ratio * size, max_size_ratio * size
cutout_img = img
for _ in range(max_crop):
  # random size
  h = np.random.randint(mini[0], maxi[0])
  w = np.random.randint(mini[1], maxi[1])
  # random place
  shift_h = np.random.randint(0, size[0] - h)
  shift_w = np.random.randint(0, size[1] - w)

  if channel_wise:
    c = np.random.randint(0, img.shape[-1])
    cutout_img[shift_h:shift_h+h, shift_w:shift_w+w, c] = replacement
    else:
      cutout_img[shift_h:shift_h+h, shift_w:shift_w+w] = replacement
```

> Does not affect the label

<img src="https://upload-images.jianshu.io/upload_images/12014150-ed2337394e6352b4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="demo_cutout.jpg" width="50%;" />

<br/>